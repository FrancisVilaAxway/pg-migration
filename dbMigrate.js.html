<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>pg-migration API</title>
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <!--<link type="text/css" rel="stylesheet" href="style.css">-->
    <meta name="derived-from" content="https://github.com/vitaly-t/pg-promise" />
</head>

<body>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-dbConnection.html">dbConnection</a></li><li><a href="module-dbInfo.html">dbInfo</a></li><li><a href="module-dbMigrate.html">dbMigrate</a></li></ul><h3>Classes</h3><ul><li><a href="dbVersion.html">dbVersion</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$main">$main</a></li></ul>
    <div class="home-link">
        <a href="https://github.com/FrankV01/pg-migration">&lt;&lt; GitHub</a>
    </div>
</nav>

<div id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @module dbMigrate */

/**
 * Migration module. Used internally to perform the principle database migrations.
 *
 * @author Frank Villasenor
 * @param {external:Database} dbConnection The Database connection on which to perform the actions
 * @param {object} migrations (can probably create a link to more doc)
 * @returns {promise} Which resolves once all
 */
module.exports = function (dbConnection, migrations) {
  "use strict";

  const $npm = {
    debug: require('debug')('db-migration:dbMigrate'),
    Version: require('./dbVersion'),
    dbInfo: require('./dbInfo'),
    dbConnection: dbConnection,
    Promise: require('bluebird')
  };

  function processVersion(migrationDataObj) {
    var versionMigrations = migrationDataObj.migrations;
    var version = migrationDataObj.version;

    return $npm.dbConnection.tx(function(t){
      var batchList = [];

      //tables
      versionMigrations.tables.map(function(tableSql) {
        batchList.push( t.none(tableSql) );
      });

      //inserts
      versionMigrations.data.map(function(dataSql) {
        batchList.push( t.tx(function(t1) {return t1.oneOrNone(dataSql); } ));
      });

      //indexes
      versionMigrations.indexes.map(function(indexSql){
        batchList.push( t.none(indexSql) );
      });

      batchList.push( t.one("UPDATE pg_migration_dbinfo set value = $1 WHERE key = 'db_version' returning value;", [version]) );

      return t.batch(batchList).then(function(output){
        //$npm.debug('[then] ', output);
        return {result:true, output:output};
      }).catch(function(er){
        $npm.debug('[error-1] Error:', er);
        throw er;
      });
    });
  }

  //filter out already deployed ersions
  return $npm.dbInfo(dbConnection)
    .then(function(verObj) {
      $npm.debug('version: ', verObj.version); //this will give us the version info.
      const currentVersion = new $npm.Version(verObj.version);

      //Remove deployed versions
      var versions = Object.keys( migrations );
      versions = versions.filter(function(v) { return v != 'latest'; });
      versions = versions.filter(function(v) {
        const myVersion = new $npm.Version(v);
        return myVersion.amNewer( currentVersion );
      });

      //we take the keys and order them...
      versions = versions.sort(function(a, b){
        var versionA = new $npm.Version(a);
        var versionB = new $npm.Version(b);
        var compareResult = versionA.compare(versionB);
        $npm.debug('[sort] compareResult', compareResult);
        return compareResult;
      });

      //Now, we need to set up a serial promise...
      var orderedVersions = versions.map(function(ver) {
        return {migrations: migrations[ver], version: ver};
      });

      return $npm.Promise.mapSeries(orderedVersions, function(item, index, length){
        return processVersion(item);
      }).then(function(out) {
        $npm.debug('[then] mapSeries is done', out);
        var result = {overallResult:true};
        out.forEach(function(val, idx) {
          result.overallResult = result.overallResult &amp;&amp; val.result;
          result[ versions[idx] ] = val;
        });
        return result;
      }).catch(function(er){
        $npm.debug('[catch] error from mapSeries', er);
        throw er;
      });
    });
};</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"></script>
</body>
</html>